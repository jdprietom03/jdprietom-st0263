# Service communication project


## Course Details


| Information  |                   |
|--------------|      :-----:      |
| Name    | Juan David Prieto M       |
| Email   | jdprietom@eafit.edu.co |
| Teacher | Edwin Montoya          |
| Course  | ST0263                 |

## Description

This project was created to practice both synchronous and asynchronous communication strategies. For this, we have set up an API that offers two microservices for listing and searching files.

The information and parameters for the project criteria are under the teacher's domain. Given this situation, it should be noted that all of the teacher's required considerations have been fully met in this project.
## Run by your own

- Start docker container for RabbitMQ in its respective instance.

```bash
  sudo docker start rabbit-server
```

- Clone the project

```bash
  git clone https://github.com/jdprietom03/jdprietom-st0263.git
```

- Go to the project directory

```bash
  cd jdprietom-st0263/reto_2/api
```

- Install NVM
```bash
    sudo apt install curl 
    sudo curl https://raw.githubusercontent.com/creationix/nvm/master/install.sh | bash 
    source ~/.bashrc   
```

- Install Node @19
```bash
    nvm install 19
```

- Install dependencies

```bash
  npm i
```

- Set the environment variables cloning the `.env.example`

```bash
  mv ./.env.example src/client
  mv ./.env.example src/server
```

- Check if stubs are created. If you need to modify the IDL, re-compile it with

```bash
  sudo npm run generate-grpc
```

### ⚠️ Warning: Use of Deprecated Library in Generated Files ⚠️

The files generated by the import command use a deprecated version of the library. It is crucial to replace in all `.js` files within the `generated/proto` folder the following code:

```javascript
require('grpc')
``` 

With the updated code:
```javascript
require('@grpc/grpc-js')
```

- To know scripts to run, use the following code:

```bash
  npm run
```

## Environment Variables

To run this project, you will need to add the following environment variables to your .env file in each **(client/server)** folder

`GRPC_HOST`
`RMQ_HOST`
`RMQ_PORT`
`RMQ_USER`
`RMQ_PASS`
`RMQ_EXCHANGE`
`RMQ_QUEUE`
`RMQ_TYPE`
`RETOME_PORT`
`PROTO_PATH`

## Directory tree

<details open>
<summary>Show Tree</summary>

```bash
    .
    ├── generated
    │   └── proto
    │       ├── FileService_grpc_pb.d.ts
    │       ├── FileService_grpc_pb.js
    │       ├── FileService_pb.d.ts
    │       ├── FileService_pb.js
    │       ├── Service_grpc_pb.d.ts
    │       ├── Service_grpc_pb.js
    │       ├── Service_pb.d.ts
    │       └── Service_pb.js
    ├── nodemon-server.json
    ├── nodemon.json
    ├── package-lock.json
    ├── package.json
    ├── proto
    │   ├── FileService.proto
    │   ├── Service.proto
    │   ├── buf.gen.yaml
    │   ├── buf.yaml
    │   └── build.sh
    ├── src
    │   ├── client
    │   │   ├── amqp-run.ts
    │   │   ├── classes
    │   │   │   ├── FileClient.ts
    │   │   │   ├── ProductClient.ts
    │   │   │   └── ProtoClient.ts
    │   │   ├── client.ts
    │   │   ├── context.ts
    │   │   └── grpc-clients.ts
    │   └── server
    │       ├── amqp-run.ts
    │       ├── consumer.ts
    │       ├── context.ts
    │       ├── data
    │       │   ├── hello.py
    │       │   └── test.txt
    │       ├── server.ts
    │       ├── services
    │       │   └── FileService.ts
    │       ├── services.ts
    │       └── wrappers
    │           ├── FileWrapperService.ts
    │           ├── ProductWrapperService.ts
    │           └── ProtoWrapperService.ts
    └── tsconfig.json

    10 directories, 37 files

```
</details>

## API Gateway Reference

#### Get all files:

```http
  curl --location '${API_HOST}/list'
```

#### Response

<details><summary> View Response </summary>

```JSON
    {
        "message": "Response received from remote service:",
        "data": {
            "fileInfoList": [
            {
                "name": "hello.py",
                "size": 20,
                "timestamp": "1693265109446"
            },
            {
                "name": "test.txt",
                "size": 10,
                "timestamp": "1693265109446"
            }
            ]
        }
    }
```

</details>

### Find files by a pattern:

```http
  curl --location '${API_HOST}/find/${pattern}'
```

#### Response

<details><summary> View Response </summary>

```http
  curl --location '${API_HOST}/find/*.py'
```

```JSON
    {
        "message": "Response received from remote service:",
        "data": {
            "filesInfoList": [
            {
                "name": "hello.py",
                "size": 20,
                "timestamp": "1693265109446"
            }
            ]
        }
    }
```

</details>

# Tech description

## Development environment

### Language
- **NodeJs + TypeScript**

### Libraries and packages
- **@grpc/grpc-js**: ^1.9.0
- **@grpc/proto-loader**: ^0.7.8
- **amqplib**: ^0.10.3
- **dotenv**: ^16.3.1
- **express**: ^4.18.2
- **multer**: ^1.4.5-lts.1
- **pino**: ^8.15.0
- **uuid**: ^9.0.0

## High Level Design and Architecture

The project employs Express as a web framework to establish an API. In addition, **gRPC** is utilized for communication between backend services, as well as **AMQP** for message publishing as a retry strategy since `RabbitMQ` is used as Message-Oriented Middleware. The code structure suggests a clear separation of responsibilities, with specific files for gateway configuration, gRPC communication, **AMQP** queue management, and resource and route definition.

Scripts in the `package.json` file offer various options for building the project, starting the server in development mode, generating gRPC files, among other tasks.

### Patterns and practices

- **RPC client**: The project defines an RPC client `FileClient` and `AMQPClient` with an AMQP server. This, to simulate a synchronous communication with the MOM.

- **Separation of Responsibilities**: There is a clear distinction between different aspects of the system, such as route management, resources, gRPC communication and AMQP queues.

- **Dependency Management**: `package.json` is used to manage project dependencies.

- **Environment-Based Configuration**: Environment variables are used for configurations, suggesting an environment-based configuration approach.

- **Modular Organization**: The code is organized in a modular fashion with a clear and defined directory structure for recognition of each aspect of the design.
## Response snapshots



## IPs


## References

- [RabbitMQ documentation](https://www.rabbitmq.com/getstarted.html)
- [JS + gRPC](https://www.rabbitmq.com/tutorials/tutorial-six-javascript.html)
- [Message-Oriented Middleware](https://www.geeksforgeeks.org/what-is-message-oriented-middleware-mom/)